<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Excelæª”æ¡ˆè™•ç†ç³»çµ±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <input type="file" id="sourceFile">
    <input type="file" id="targetFile">
    <button id="processBtn" disabled>ğŸš€ é–‹å§‹è™•ç†æª”æ¡ˆ</button>
    <div id="sourceInfo" style="display:none;"></div>
    <div id="targetInfo" style="display:none;"></div>
    <div id="status" style="display:none;"></div>
    <div id="downloadSection" style="display:none;"></div>
    
<script>
    let sourceData = null;
    let targetData = null;
    let sourceFileName = '';
    let targetFileName = '';

    const sourceFileInput = document.getElementById('sourceFile');
    const targetFileInput = document.getElementById('targetFile');
    const processBtn = document.getElementById('processBtn');
    const status = document.getElementById('status');
    const downloadSection = document.getElementById('downloadSection');

    function showStatus(message, type = 'processing') {
        status.textContent = message;
        status.className = `status ${type}`;
        status.style.display = 'block';
    }

    function hideStatus() {
        status.style.display = 'none';
    }

    function checkFilesReady() {
        if (sourceData && targetData) {
            processBtn.disabled = false;
            processBtn.textContent = 'ğŸš€ é–‹å§‹è™•ç†æª”æ¡ˆ';
        } else {
            processBtn.disabled = true;
            processBtn.textContent = 'è«‹å…ˆé¸æ“‡æª”æ¡ˆ';
        }
    }

    function readExcelFile(file, callback) {
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = e.target.result;
                const workbook = XLSX.read(data, {type: 'binary'});
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1, raw: false});
                callback(jsonData, null);
            } catch (error) {
                callback(null, `è®€å–æª”æ¡ˆå¤±æ•—: ${error.message}`);
            }
        };
        reader.readAsBinaryString(file);
    }

    sourceFileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            sourceFileName = file.name;
            showStatus('æ­£åœ¨è®€å–ä¾†æºæª”æ¡ˆ...', 'processing');
            readExcelFile(file, function(data, error) {
                if (error) {
                    showStatus(error, 'error');
                    sourceData = null;
                } else {
                    sourceData = data;
                    document.getElementById('sourceInfo').innerHTML = `
                        <strong>âœ… ${file.name}</strong><br>
                        å…± ${data.length} è¡Œè³‡æ–™
                    `;
                    document.getElementById('sourceInfo').style.display = 'block';
                    showStatus('ä¾†æºæª”æ¡ˆè®€å–æˆåŠŸï¼', 'success');
                    setTimeout(hideStatus, 2000);
                }
                checkFilesReady();
            });
        }
    });

    targetFileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            targetFileName = file.name;
            showStatus('æ­£åœ¨è®€å–ç›®æ¨™æª”æ¡ˆ...', 'processing');
            readExcelFile(file, function(data, error) {
                if (error) {
                    showStatus(error, 'error');
                    targetData = null;
                } else {
                    targetData = data;
                    document.getElementById('targetInfo').innerHTML = `
                        <strong>âœ… ${file.name}</strong><br>
                        å…± ${data.length} è¡Œè³‡æ–™
                    `;
                    document.getElementById('targetInfo').style.display = 'block';
                    showStatus('ç›®æ¨™æª”æ¡ˆè®€å–æˆåŠŸï¼', 'success');
                    setTimeout(hideStatus, 2000);
                }
                checkFilesReady();
            });
        }
    });

    function getColumnValue(row, colIndex) {
        return row[colIndex] || '';
    }

    function processFiles() {
        if (!sourceData || !targetData) {
            showStatus('è«‹å…ˆé¸æ“‡å…©å€‹æª”æ¡ˆ', 'error');
            return;
        }

        showStatus('æ­£åœ¨è™•ç†æª”æ¡ˆè³‡æ–™...', 'processing');

        try {
            const negativeData = {};

            for (let i = 5; i < sourceData.length; i++) {
                const row = sourceData[i];
                if (!row || row.length === 0) continue;

                let aValue = getColumnValue(row, 0).toString();
                const ivrCode = aValue.substring(0, 7);

                const qRaw = getColumnValue(row, 16).toString().replace(/,/g, '').trim();
                const qNumber = parseFloat(qRaw);

                if (!isNaN(qNumber) && qNumber < 0 && ivrCode) {
                    negativeData[ivrCode] = qNumber;
                }
            }

            const resultData = targetData.map(row => [...row]);
            let matchCount = 0;

            for (let i = 0; i < resultData.length; i++) {
                const row = resultData[i];
                if (!row || row.length === 0) continue;

                let targetIvrCode = getColumnValue(row, 0).toString();
                const cleanIvrCode = targetIvrCode.substring(0, 7);

                if (cleanIvrCode && negativeData.hasOwnProperty(cleanIvrCode)) {
                    while (row.length <= 4) {
                        row.push('');
                    }
                    row[4] = negativeData[cleanIvrCode];
                    matchCount++;
                }
            }

            const newWorkbook = XLSX.utils.book_new();
            const newWorksheet = XLSX.utils.aoa_to_sheet(resultData);
            XLSX.utils.book_append_sheet(newWorkbook, newWorksheet, 'ProcessedData');

            const wbout = XLSX.write(newWorkbook, {bookType: 'xlsx', type: 'binary'});
            const blob = new Blob([s2ab(wbout)], {type: 'application/octet-stream'});
            const url = URL.createObjectURL(blob);

            const downloadLink = document.createElement('a');
            downloadLink.href = url;
            downloadLink.download = `processed_${targetFileName}`;
            downloadLink.className = 'download-btn';
            downloadLink.textContent = `ä¸‹è¼‰è™•ç†çµæœ (å·²åŒ¹é… ${matchCount} ç­†è³‡æ–™)`;

            downloadSection.innerHTML = `
                <h3>âœ… è™•ç†å®Œæˆï¼</h3>
                <p>æˆåŠŸè™•ç†æª”æ¡ˆï¼Œå…±åŒ¹é… <strong>${matchCount}</strong> ç­†è² æ•¸è³‡æ–™</p>
                <p>æ‰¾åˆ° <strong>${Object.keys(negativeData).length}</strong> ç­†ä¾†æºè² æ•¸è³‡æ–™</p>
            `;
            downloadSection.appendChild(downloadLink);
            downloadSection.style.display = 'block';

            showStatus(`è™•ç†å®Œæˆï¼å…±åŒ¹é… ${matchCount} ç­†è³‡æ–™`, 'success');

        } catch (error) {
            console.error('è™•ç†éŒ¯èª¤:', error);
            showStatus(`è™•ç†å¤±æ•—: ${error.message}`, 'error');
        }
    }

    function s2ab(s) {
        const buf = new ArrayBuffer(s.length);
        const view = new Uint8Array(buf);
        for (let i = 0; i < s.length; i++) {
            view[i] = s.charCodeAt(i) & 0xFF;
        }
        return buf;
    }

    processBtn.addEventListener('click', processFiles);
</script>

</body>
</html>
